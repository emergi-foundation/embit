#!/bin/bash
#
# Pre-push hook to run tests before pushing
# Prevents pushing code that would fail tests in CI/CD
#

set -e

echo "üöÄ Running pre-push checks..."

# Get the remote and URL being pushed to
remote="$1"
url="$2"

echo "üìç Pushing to: $remote ($url)"

# Check if we're pushing to main/master branch
current_branch=$(git rev-parse --abbrev-ref HEAD)
if [ "$current_branch" = "master" ] || [ "$current_branch" = "main" ]; then
    echo "‚ö†Ô∏è  Pushing to $current_branch - running full test suite..."
    RUN_FULL_TESTS=true
else
    echo "‚ÑπÔ∏è  Pushing to $current_branch - running basic tests..."
    RUN_FULL_TESTS=false
fi

# Run Kotlin compilation check for all modules
echo "üî® Checking Kotlin compilation..."
if ! ./gradlew compileDebugKotlin --no-daemon --quiet; then
    echo "‚ùå Compilation failed! Fix compilation errors before pushing."
    echo "Run: ./gradlew compileDebugKotlin for details"
    exit 1
fi
echo "‚úÖ Compilation check passed"

# Run unit tests
echo "üß™ Running unit tests..."
if [ "$RUN_FULL_TESTS" = true ]; then
    # Run all tests for main/master branches
    if ! ./gradlew test --no-daemon; then
        echo "‚ùå Tests failed! Fix failing tests before pushing to $current_branch."
        echo "Run: ./gradlew test --continue for details"
        exit 1
    fi
else
    # For other branches, just run shared module tests (faster)
    if ! ./gradlew :shared:testDebugUnitTest --no-daemon --quiet; then
        echo "‚ö†Ô∏è  Some tests failed. Consider fixing them before pushing."
        echo "Run: ./gradlew :shared:testDebugUnitTest for details"
        # Don't fail - just warn for feature branches
        echo "‚ö†Ô∏è  Continuing with push..."
    fi
fi
echo "‚úÖ Tests passed"

# Check for untracked files that might be needed
UNTRACKED_FILES=$(git ls-files --others --exclude-standard)
if [ -n "$UNTRACKED_FILES" ]; then
    echo "‚ö†Ô∏è  Warning: You have untracked files:"
    echo "$UNTRACKED_FILES" | head -5
    if [ $(echo "$UNTRACKED_FILES" | wc -l) -gt 5 ]; then
        echo "... and $(( $(echo "$UNTRACKED_FILES" | wc -l) - 5 )) more"
    fi
    echo "‚ÑπÔ∏è  Make sure you haven't forgotten to add any necessary files"
fi

echo "‚úÖ Pre-push checks passed! Pushing to remote..."
exit 0
