name: Android Production Release

on:
  workflow_dispatch:
    inputs:
      version_name:
        description: 'Version name (e.g., 2.0.0)'
        required: true
      version_code:
        description: 'Version code (integer, e.g., 2)'
        required: true
      create_release:
        description: 'Create GitHub release?'
        required: true
        type: boolean
        default: true

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Accept Android SDK licenses
        run: yes | sdkmanager --licenses || true

      - name: Decode and save keystore
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > embit-release.jks

      - name: Create google-services.json
        run: |
          cat <<'EOF' > androidApp/google-services.json
          ${{ secrets.GOOGLE_SERVICES_JSON_PROD }}
          EOF

      - name: Update version in build.gradle.kts
        run: |
          sed -i "s/versionCode = [0-9]*/versionCode = ${{ github.event.inputs.version_code }}/" androidApp/build.gradle.kts
          sed -i "s/versionName = \"[^\"]*\"/versionName = \"${{ github.event.inputs.version_name }}\"/" androidApp/build.gradle.kts

      - name: Run unit tests
        run: ./gradlew shared:testDebug --stacktrace
        continue-on-error: false

      - name: Build Production Release AAB
        env:
          KEYSTORE_FILE: embit-release.jks
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: ./gradlew :androidApp:bundleProductionRelease --stacktrace

      - name: Upload Production AAB
        uses: actions/upload-artifact@v4
        with:
          name: embit-production-release-v${{ github.event.inputs.version_name }}
          path: androidApp/build/outputs/bundle/productionRelease/androidApp-production-release.aab
          retention-days: 90

      - name: Upload mapping file (ProGuard)
        uses: actions/upload-artifact@v4
        with:
          name: embit-mapping-v${{ github.event.inputs.version_name }}
          path: androidApp/build/outputs/mapping/productionRelease/mapping.txt
          retention-days: 90

      - name: Create GitHub Release
        if: ${{ github.event.inputs.create_release == 'true' }}
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.event.inputs.version_name }}
          name: Release v${{ github.event.inputs.version_name }}
          body: |
            ## Embit App Release v${{ github.event.inputs.version_name }}

            ### What's New
            - Grid Awareness & Smart Charging
            - Battery Health Monitoring
            - User Authentication & Cloud Sync
            - Real-time Grid Status Tracking

            ### Build Information
            - **Version Code:** ${{ github.event.inputs.version_code }}
            - **Version Name:** ${{ github.event.inputs.version_name }}
            - **Commit:** ${{ github.sha }}
            - **Build Date:** ${{ github.event.repository.updated_at }}

            ### Installation
            Download the AAB from artifacts and upload to Google Play Console.

            ### Testing
            - âœ… All unit tests passed
            - âœ… ProGuard obfuscation enabled
            - âœ… Signed with production keystore
          draft: true
          prerelease: false
          files: |
            androidApp/build/outputs/bundle/productionRelease/androidApp-production-release.aab
            androidApp/build/outputs/mapping/productionRelease/mapping.txt

      - name: Build summary
        run: |
          echo "### ðŸš€ Production Build Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ github.event.inputs.version_name }} (build ${{ github.event.inputs.version_code }})" >> $GITHUB_STEP_SUMMARY
          echo "- **Flavor:** production" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Type:** release (signed)" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… All unit tests passed" >> $GITHUB_STEP_SUMMARY
          echo "âœ… AAB signed with production keystore" >> $GITHUB_STEP_SUMMARY
          echo "âœ… ProGuard obfuscation enabled" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next Steps:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Download the AAB from artifacts" >> $GITHUB_STEP_SUMMARY
          echo "2. Test the AAB with Google Play Console's internal testing" >> $GITHUB_STEP_SUMMARY
          echo "3. Upload to Google Play Console for review" >> $GITHUB_STEP_SUMMARY
          echo "4. Save the mapping.txt file for crash reporting" >> $GITHUB_STEP_SUMMARY
